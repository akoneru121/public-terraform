name: Terraform Drift Detection

on:
  schedule:
    - cron: '0 8 * * 1-5'  # Monday-Friday at 8 AM UTC
  workflow_dispatch:

env:
  TF_VERSION: '1.6.0'
  AWS_REGION: us-east-1
  TF_VAR_project_name: public

jobs:
  drift:
    name: Detect Configuration Drift
    runs-on: ubuntu-latest
    permissions:
      contents: read
      issues: write
      id-token: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-DriftDetection

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TF_VERSION }}

      - name: Terraform Init
        run: |
          terraform init \
            -backend-config="bucket=${{ secrets.TF_STATE_BUCKET }}" \
            -backend-config="key=public/terraform.tfstate" \
            -backend-config="region=us-east-1" \
            -backend-config="dynamodb_table=${{ secrets.TF_STATE_LOCK_TABLE }}"

      - name: Terraform Plan (Drift Check)
        id: plan
        run: |
          set +e
          set -o pipefail
          terraform plan -detailed-exitcode -var-file="terraform.tfvars" -no-color 2>&1 | tee drift.txt
          EXIT_CODE=$?
          echo "exitcode=$EXIT_CODE" >> $GITHUB_OUTPUT
          
          # Exit code 0 = no changes (success)
          # Exit code 2 = changes detected (drift) - also success, continue to check_drift
          # Exit code 1 = error (failure)
          if [ $EXIT_CODE -eq 1 ]; then
            echo "‚ùå Terraform plan encountered an error"
            exit 1
          elif [ $EXIT_CODE -eq 2 ]; then
            echo "‚ö†Ô∏è Configuration drift detected (exit code 2)"
          else
            echo "‚úÖ No drift detected (exit code 0)"
          fi
          
          # Don't exit for 0 or 2, let the step continue naturally

      - name: Check for drift
        if: always() && steps.plan.outcome == 'success'
        id: check_drift
        run: |
          # Exit code 0 = no changes, 2 = changes detected
          EXIT_CODE="${{ steps.plan.outputs.exitcode }}"
          if [ "$EXIT_CODE" -eq 2 ]; then
            echo "drift_detected=true" >> $GITHUB_OUTPUT
            echo "‚ö†Ô∏è Configuration drift detected!"
          else
            echo "drift_detected=false" >> $GITHUB_OUTPUT
            echo "‚úÖ No configuration drift detected"
          fi

      - name: Create drift issue
        if: steps.check_drift.outputs.drift_detected == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const drift = fs.readFileSync('drift.txt', 'utf8');
            
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '‚ö†Ô∏è Terraform Configuration Drift Detected',
              labels: ['terraform', 'drift', 'infrastructure'],
              body: `## Configuration Drift Detected
              
              Automated drift detection has found differences between your Terraform state and actual AWS infrastructure.
              
              **Detection Time:** ${new Date().toISOString()}
              **Project:** public
              **Region:** us-east-1
              
              ### Drift Details
              
              <details>
              <summary>Show Drift</summary>
              
              \`\`\`terraform
              ${drift.slice(0, 60000)}
              \`\`\`
              
              </details>
              
              ### Recommended Actions
              
              1. Review the drift details above
              2. Determine if changes were intentional (manual changes in AWS Console)
              3. If intentional, update Terraform code to match
              4. If unintentional, run \`terraform apply\` to restore desired state
              5. Investigate why manual changes were made
              
              ### Commands to Fix
              
              \`\`\`bash
              # Review the drift
              terraform plan
              
              # Apply to fix drift (if changes were unintentional)
              terraform apply
              
              # Or update Terraform code to match (if changes were intentional)
              terraform refresh
              terraform plan
              \`\`\`
              
              **Workflow Run:** [View Details](${context.payload.repository.html_url}/actions/runs/${context.runId})
              `
            });
            
            console.log(\`Created issue #\${issue.data.number}\`);

      - name: Post summary
        if: always()
        run: |
          cat >> $GITHUB_STEP_SUMMARY <<EOF
          ## üîç Drift Detection Summary
          
          **Status:** ${{ steps.check_drift.outputs.drift_detected }}
          **Project:** public
          **Region:** us-east-1
          **Time:** $(date -u)
          
          $(if [ "${{ steps.check_drift.outputs.drift_detected }}" == "true" ]; then
            echo "‚ö†Ô∏è **Drift Detected** - An issue has been created for review"
          elif [ "${{ steps.check_drift.outputs.drift_detected }}" == "false" ]; then
            echo "‚úÖ **No Drift** - Infrastructure matches Terraform state"
          else
            echo "‚ùå **Error** - Drift detection failed"
          fi)
          EOF